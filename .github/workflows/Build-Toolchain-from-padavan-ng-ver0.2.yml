name: Build Toolchain from padavan-ng ver 0.2

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

env:
  TOOLCHAIN_FILE: toolchain.tzst
  TOOLCHAIN_NAME: padavan-toolchain
  PADAVAN_REPO: https://github.com/nilabsent/padavan-ng.git

jobs:
  build-toolchain:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        
    - name: Clone padavan-ng repository
      run: |
        git clone --depth 1 --branch master ${{ env.PADAVAN_REPO }} padavan-src
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install --no-install-recommends -y \
          autoconf automake bison bzip2 ca-certificates flex g++ \
          gawk gcc git gperf help2man libncurses5-dev libstdc++6 \
          libtool libtool-bin make patch texinfo unzip wget xz-utils \
          zstd python3 meson ninja-build

    - name: Build toolchain from padavan-ng
      run: |
        cd padavan-src/toolchain
        chmod +x *.sh
        ./clean_sources.sh
        ./build_toolchain.sh
        
    - name: Create toolchain archive
      run: |
        mkdir -p temp_toolchain/toolchain
        cp -r padavan-src/toolchain/out temp_toolchain/toolchain/
        # ИСПРАВЛЕНО: архивируем только папку toolchain, без точки
        tar -I "zstd -9 -T0" -cf ${{ env.TOOLCHAIN_FILE }} -C temp_toolchain toolchain
        echo "Archive created: ${{ env.TOOLCHAIN_FILE }}"
        echo "Archive structure:"
        tar -I zstd -tf ${{ env.TOOLCHAIN_FILE }} | head -10
        
    - name: Upload toolchain as artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.TOOLCHAIN_NAME }}
        path: ${{ env.TOOLCHAIN_FILE }}
        retention-days: 30
        
    - name: Generate release tag and name
      id: vars
      run: |
        CURRENT_DATE=$(date +'%Y%m%d-%H%M%S')
        echo "tag_name=toolchain-$CURRENT_DATE" >> $GITHUB_OUTPUT
        echo "release_name=Toolchain Build $CURRENT_DATE" >> $GITHUB_OUTPUT
        
    - name: Create GitHub Release
      uses: ncipollo/release-action@v1
      with:
        artifacts: ${{ env.TOOLCHAIN_FILE }}
        tag: ${{ steps.vars.outputs.tag_name }}
        name: ${{ steps.vars.outputs.release_name }}
        body: |
          Automatically built toolchain from nilabsent/padavan-ng
          
          **Source:** ${{ env.PADAVAN_REPO }}
          **Build Date:** ${{ steps.vars.outputs.release_name }}
          
          **Archive Structure:**
          ```
          toolchain.tzst
          └── toolchain/
              └── out/
                  ├── bin/
                  ├── lib/
                  └── ...
          ```
          
          **Usage:**
          ```bash
          # Extract to current directory
          tar -I zstd -xf toolchain.tzst
          
          # Use in builds
          export PATH="$PWD/toolchain/out/bin:$PATH"
          export CROSS_COMPILE="mipsel-linux-uclibc-"
          
          # Verify
          mipsel-linux-uclibc-gcc --version
          ```
        draft: false
        prerelease: false
