name: Build firmware for multiple routers

on:
  workflow_dispatch:
    inputs:
      router_model:
        description: "Router model"
        type: string
        required: true
        default: "tplink-c5-v4-16M"

jobs:
  build:
    runs-on: ubuntu-22.04
    container: registry.gitlab.com/hadzhioglu/padavan-ng
    defaults: { run: { shell: bash } }
    
    steps:
    - uses: actions/checkout@v4

    - name: Debug workspace structure
      run: |
        echo "=== Workspace structure ==="
        pwd
        ls -la
        echo "=== Patches directory ==="
        find . -name "patches" -type d 2>/dev/null | head -5
        if [ -d "patches" ]; then
          find patches -type f -name "*.patch" | head -10
        fi

    - name: Get variables
      run: |
        sed -i 's|\r$||g' variables build-${{ github.event.inputs.router_model }}.config
        . <(cat variables build-${{ github.event.inputs.router_model }}.config)
        for v in "${!PADAVAN_@}" "${!CONFIG_@}"; do
          echo "$v=${!v}" >> $GITHUB_ENV
        done

    - name: Download sources and toolchain
      run: |
        git config --global --add safe.directory '*'
        git clone --depth 1 -b "$PADAVAN_BRANCH" "https://github.com/nilabsent/padavan-ng.git"
        if [ "$PADAVAN_COMMIT" != "HEAD" ]; then
          git -C padavan-ng checkout "$PADAVAN_COMMIT"
        fi
        
        # Скачиваем наш toolchain вместо GitLab
        REPO_URL="https://github.com/${{ github.repository }}"
        wget -qO- "$REPO_URL/releases/latest/download/toolchain.tzst" | tar -C padavan-ng --zstd -xf -

    - name: Build firmware
      run: |
        ROUTER_MODEL="${{ github.event.inputs.router_model }}"
        WORKSPACE_PATH="$GITHUB_WORKSPACE"
        
        echo "=== FIRMWARE BUILD STARTED ==="
        echo "Router: $ROUTER_MODEL"
        echo "Workspace: $WORKSPACE_PATH"

        # ========== ОТЛАДКА ПАТЧЕЙ ==========
        echo "=== DEBUG PATCHES ==="
        echo "Patches directory exists: $(if [ -d "$WORKSPACE_PATH/patches/$ROUTER_MODEL" ]; then echo "YES"; else echo "NO"; fi)"
        
        if [ -d "$WORKSPACE_PATH/patches/$ROUTER_MODEL" ]; then
          echo "Patch files found:"
          ls -la "$WORKSPACE_PATH/patches/$ROUTER_MODEL/" || echo "No patch files"
          
          # Проверяем содержимое патчей
          for patch_file in $WORKSPACE_PATH/patches/$ROUTER_MODEL/*.patch; do
            echo "=== Patch content: $(basename $patch_file) ==="
            head -30 "$patch_file"
            echo "..."
          done
        fi

        # ========== ПРИМЕНЕНИЕ ПАТЧЕЙ ==========
        if [ -d "$WORKSPACE_PATH/patches/$ROUTER_MODEL" ] && [ "$(ls -A $WORKSPACE_PATH/patches/$ROUTER_MODEL/*.patch 2>/dev/null)" ]; then
          echo "=== APPLYING PATCHES ==="
          cd padavan-ng
          
          # Сохраняем исходное состояние
          echo "Initial git status:"
          git status --porcelain | head -10 || echo "No changes"
          
          for patch_file in $WORKSPACE_PATH/patches/$ROUTER_MODEL/*.patch; do
            echo "--- Applying: $(basename $patch_file) ---"
            
            # Показываем что патч меняет
            echo "Patch will modify:"
            grep -E "^--- a/|^+++ b/" "$patch_file" | head -5
            
            # Пробуем применить через git
            if git apply --check "$patch_file" 2>/dev/null; then
              git apply "$patch_file"
              echo "✓ Git apply successful"
            else
              echo "⚠ Git apply failed, trying patch command..."
              # Применяем с максимальной терпимостью
              if patch -p1 --forward --ignore-whitespace --silent < "$patch_file"; then
                echo "✓ Patch command successful"
              else
                echo "❌ Patch application failed"
                echo "Showing patch content for debugging:"
                cat "$patch_file"
              fi
            fi
          done
          
          # Проверяем изменения
          echo "Final git status:"
          git status --porcelain | head -10 || echo "No changes detected"
          
          # Проверяем конкретно mktplinkfw2
          echo "=== VERIFYING MKTPLINKFW2 ==="
          if [ -f "trunk/tools/mktplinkfw2.c" ]; then
            echo "mktplinkfw2.c size check:"
            grep -A2 -B2 "kernel_size + rootfs_size" trunk/tools/mktplinkfw2.c || echo "Size check not found"
            
            echo "mktplinkfw2 error message:"
            grep -A2 -B2 "images are too big" trunk/tools/mktplinkfw2.c || echo "Error message not found"
          fi
          
          cd ..
        else
          echo "=== NO PATCHES FOUND ==="
        fi

        # ========== КОПИРОВАНИЕ КОНФИГУРАЦИЙ ==========
        echo "=== COPYING CONFIGURATIONS ==="
        if [ -d "$WORKSPACE_PATH/routers/$ROUTER_MODEL" ] && [ "$(ls -A $WORKSPACE_PATH/routers/$ROUTER_MODEL)" ]; then
          echo "Copying config files for $ROUTER_MODEL..."
          cp -rv $WORKSPACE_PATH/routers/$ROUTER_MODEL/* padavan-ng/trunk/configs/
        else
          echo "No config files found for $ROUTER_MODEL"
        fi

        # Копируем основной конфиг
        echo "Copying main config..."
        cp $WORKSPACE_PATH/build-$ROUTER_MODEL.config padavan-ng/trunk/.config

        # Дополнительные файлы
        if [ -f "$WORKSPACE_PATH/rules" ]; then
          cp -v $WORKSPACE_PATH/rules padavan-ng/trunk/
        fi
        if [ -f "$WORKSPACE_PATH/Makefile" ]; then
          cp -v $WORKSPACE_PATH/Makefile padavan-ng/trunk/
        fi

        # ========== СБОРКА ПРОШИВКИ ==========
        echo "=== BUILDING FIRMWARE ==="
        cd padavan-ng/trunk
        
        # Очистка и сборка
        ./clear_tree.sh
        ./build_firmware.sh

        # ========== ПОИСК РЕЗУЛЬТАТА ==========
        echo "=== FINDING FIRMWARE ==="
        FW_FILE_NAME="$(find images -type f -regextype posix-extended -iregex ".*\.(trx|bin)$" \
                        -printf "%T@\t%f\n" | sort -V | tail -1 | cut -f2)"
        
        if [[ -n $FW_FILE_NAME ]]; then
          echo "✓ Firmware found: $FW_FILE_NAME"
          echo "FW_FILE_NAME=$FW_FILE_NAME" >> $GITHUB_ENV
        else
          echo "❌ Firmware file not found"
          echo "Available files in images/:"
          find images -type f -ls 2>/dev/null || ls -la images/ 2>/dev/null || echo "Images directory not found"
          exit 1
        fi

    - name: Prepare artifacts
      run: |
        cp "padavan-ng/trunk/images/$FW_FILE_NAME" .
        echo "BUILD_TIMESTAMP=$(date '+%Y.%m.%d_%H.%M.%S')" >> $GITHUB_ENV

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: padavan-ng_${{ env.CONFIG_VENDOR }}_${{ env.CONFIG_FIRMWARE_PRODUCT_ID }}_${{ env.BUILD_TIMESTAMP }}
        retention-days: 7
        path: |
          ${{ env.FW_FILE_NAME }}
          build-${{ github.event.inputs.router_model }}.config

    - name: Check firmware size
      run: |
        ROUTER_MODEL="${{ github.event.inputs.router_model }}"
        partitions="padavan-ng/trunk/configs/boards/$CONFIG_VENDOR/$CONFIG_FIRMWARE_PRODUCT_ID/partitions.config"
        max_fw_size="$(awk '/Firmware/ { getline; getline; sub(",", ""); print strtonum($2); }' "$partitions")"
        fw_size="$(stat -c %s "$FW_FILE_NAME")"

        if ((fw_size > max_fw_size)); then
          fw_size_fmtd="$(numfmt --grouping "$fw_size") bytes"
          max_fw_size_fmtd="$(numfmt --grouping "$max_fw_size") bytes"
          echo "Firmware size ($fw_size_fmtd) exceeds max size ($max_fw_size_fmtd) for $ROUTER_MODEL"
          exit 1
        fi
