name: Build firmware for multiple routers

on:
  workflow_dispatch:
    inputs:
      router_model:
        description: "Router model"
        type: string
        required: true
        default: "tplink-c5-v4-16M"

jobs:
  build:
    runs-on: ubuntu-22.04
    defaults: { run: { shell: bash } }
    
    steps:
    - uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          autoconf \
          automake \
          libtool \
          pkg-config \
          flex \
          bison \
          gettext \
          texinfo \
          gperf \
          libncurses5-dev \
          lib32z1-dev \
          python3 \
          meson \
          ninja-build \
          cmake \
          make \
          gcc \
          g++ \
          git \
          wget \
          curl \
          unzip \
          xz-utils \
          zstd

    - name: Clone nilabsent/padavan-ng repository
      run: |
        git config --global --add safe.directory '*'
        git clone --depth 1 -b master "https://github.com/nilabsent/padavan-ng.git"

    - name: Download and setup toolchain
      run: |
        REPO_URL="https://github.com/${{ github.repository }}"
        echo "Downloading toolchain from: $REPO_URL"
        
        # Скачиваем toolchain
        wget -O toolchain.tzst "$REPO_URL/releases/latest/download/toolchain.tzst"
        
        # Распаковываем в padavan-ng (как ожидает оригинальный скрипт)
        tar -I zstd -xf toolchain.tzst -C padavan-ng/
        
        echo "✓ Toolchain verification:"
        ls -la padavan-ng/toolchain/out/bin/mipsel-linux-uclibc-gcc

    - name: Setup environment
      run: |
        # Настраиваем PATH для toolchain
        export PATH="$GITHUB_WORKSPACE/padavan-ng/toolchain/out/bin:$PATH"
        echo "PATH=$GITHUB_WORKSPACE/padavan-ng/toolchain/out/bin:$PATH" >> $GITHUB_ENV
        echo "CROSS_COMPILE=mipsel-linux-uclibc-" >> $GITHUB_ENV
        
        # Проверяем что toolchain работает
        mipsel-linux-uclibc-gcc --version

    - name: Get variables
      run: |
        sed -i 's|\r$||g' variables build-${{ github.event.inputs.router_model }}.config
        . <(cat variables build-${{ github.event.inputs.router_model }}.config)
        for v in "${!PADAVAN_@}" "${!CONFIG_@}"; do
          echo "$v=${!v}" >> $GITHUB_ENV
        done

    - name: Build firmware
      run: |
        ROUTER_MODEL="${{ github.event.inputs.router_model }}"
        
        # Применяем патчи
        if [ -d "patches/$ROUTER_MODEL" ] && [ "$(ls -A patches/$ROUTER_MODEL/*.patch 2>/dev/null)" ]; then
          echo "Applying patches for $ROUTER_MODEL..."
          cd padavan-ng
          for patch_file in ../patches/$ROUTER_MODEL/*.patch; do
            echo "Applying patch: $(basename $patch_file)"
            patch -p1 --forward < "$patch_file" || true
          done
          cd ..
        fi

        # Копируем файлы конфигурации
        if [ -d "routers/$ROUTER_MODEL" ] && [ "$(ls -A routers/$ROUTER_MODEL)" ]; then
          echo "Copying config files for $ROUTER_MODEL..."
          cp -rv routers/$ROUTER_MODEL/* padavan-ng/trunk/configs/
        fi

        # Копируем основной конфиг
        cp build-$ROUTER_MODEL.config padavan-ng/trunk/.config

        # Сборка прошивки
        cd padavan-ng/trunk
        ./clear_tree.sh
        ./build_firmware.sh

        # Поиск файла прошивки
        FW_FILE_NAME="$(find images -type f -name "*.trx" -o -name "*.bin" | head -1)"
        [[ -n $FW_FILE_NAME ]] || { echo "Firmware file not found"; exit 1; }
        echo "FW_FILE_NAME=$(basename $FW_FILE_NAME)" >> $GITHUB_ENV

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware_${{ github.event.inputs.router_model }}
        path: padavan-ng/trunk/images/${{ env.FW_FILE_NAME }}
